# MQTT + Celery æ¸¬è©¦å¥—ä»¶

é€™å€‹ç›®éŒ„åŒ…å«äº†å®Œæ•´çš„ MQTT + Celery æ•´åˆæ¸¬è©¦å¥—ä»¶ï¼Œç”¨æ–¼é©—è­‰ IoT è¨­å‚™æ¶ˆæ¯è™•ç†æ¶æ§‹ã€‚

## ğŸ“ ç›®éŒ„çµæ§‹

```
koala/mqtt/test/
â”œâ”€â”€ README.md                           # æœ¬æ–‡æª”
â”œâ”€â”€ __init__.py                         # Pythonæ¨¡çµ„åˆå§‹åŒ–
â”œâ”€â”€ run_tests.sh                        # ğŸš€ æ¸¬è©¦åŸ·è¡Œè…³æœ¬ (æ¨è–¦ä½¿ç”¨)
â”œâ”€â”€ run_all_tests.py                    # Pythonæ¸¬è©¦å¥—ä»¶
â”œâ”€â”€ test_single_queue_architecture.py   # å–®ä¸€éšŠåˆ—æ¶æ§‹æ¸¬è©¦
â””â”€â”€ iot_device_simulator.py            # IoTè¨­å‚™æ¨¡æ“¬å™¨
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ä½¿ç”¨æ¸¬è©¦è…³æœ¬ (æ¨è–¦)

```bash
# é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯
./koala/mqtt/test/run_tests.sh --help

# æª¢æŸ¥æœå‹™ç‹€æ…‹
./koala/mqtt/test/run_tests.sh --check

# é‹è¡ŒåŸºæœ¬æ¸¬è©¦ (ä¸åŒ…å«IoTæ¨¡æ“¬å™¨)
./koala/mqtt/test/run_tests.sh --test

# é‹è¡Œå®Œæ•´æ¸¬è©¦ (åŒ…å«IoTæ¨¡æ“¬å™¨)
./koala/mqtt/test/run_tests.sh --full

# é‡å•Ÿæœå‹™ä¸¦é‹è¡Œå®Œæ•´æ¸¬è©¦
./koala/mqtt/test/run_tests.sh --restart

# é¡¯ç¤ºæœå‹™æ—¥èªŒ
./koala/mqtt/test/run_tests.sh --logs
```

### ç›´æ¥é‹è¡Œ Python æ¸¬è©¦

```bash
# é‹è¡ŒåŸºæœ¬æ¶æ§‹æ¸¬è©¦
docker-compose -f backend-local.yml exec koala-iot-default-worker python koala/mqtt/test/run_all_tests.py

# é‹è¡ŒåŒ…å«IoTæ¨¡æ“¬å™¨çš„å®Œæ•´æ¸¬è©¦
docker-compose -f backend-local.yml exec koala-iot-default-worker python koala/mqtt/test/run_all_tests.py --include-iot-simulator

# å–®ç¨é‹è¡ŒIoTè¨­å‚™æ¨¡æ“¬å™¨
docker-compose -f backend-local.yml exec koala-iot-default-worker python koala/mqtt/test/iot_device_simulator.py --bikes 3 --duration 5
```

## ğŸ“‹ æ¸¬è©¦å¥—ä»¶èªªæ˜

### 1. å–®ä¸€éšŠåˆ—æ¶æ§‹æ¸¬è©¦ (`test_single_queue_architecture.py`)

æ¸¬è©¦æ–°çš„å–®ä¸€éšŠåˆ—æ¶æ§‹ï¼Œé©—è­‰åŸºæ–¼ `message_type` çš„è·¯ç”±æ©Ÿåˆ¶ï¼š

- âœ… MQTT é€£æ¥æ¸¬è©¦
- âœ… é™æ¸¬æ¶ˆæ¯ç™¼å¸ƒæ¸¬è©¦
- âœ… è»ŠéšŠç®¡ç†æ¶ˆæ¯ç™¼å¸ƒæ¸¬è©¦
- âœ… é‹å‹•æ¶ˆæ¯ç™¼å¸ƒæ¸¬è©¦
- âœ… æœªçŸ¥æ¶ˆæ¯é¡å‹è™•ç†æ¸¬è©¦

**æ¸¬è©¦æµç¨‹**ï¼š
1. å»ºç«‹ MQTT é€£æ¥
2. ç™¼å¸ƒå„ç¨®é¡å‹çš„æ¸¬è©¦æ¶ˆæ¯
3. é©—è­‰ Celery ä»»å‹™è¢«æ­£ç¢ºè§¸ç™¼
4. æª¢æŸ¥æ¶ˆæ¯è™•ç†çµæœ

### 2. IoT è¨­å‚™æ¨¡æ“¬å™¨ (`iot_device_simulator.py`)

æ¨¡æ“¬çœŸå¯¦çš„ IoT è¨­å‚™è¡Œç‚ºï¼Œç™¼é€å„ç¨®é¡å‹çš„æ•¸æ“šï¼š

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ğŸš² æ¨¡æ“¬å¤šè¼›è…³è¸è»Šè¨­å‚™
- ğŸ“¡ ç™¼é€é™æ¸¬æ•¸æ“š (ä½ç½®ã€é›»æ± ã€é€Ÿåº¦ç­‰)
- ğŸ¢ ç™¼é€è»ŠéšŠç®¡ç†æ•¸æ“š (ç‹€æ…‹ã€ç¶­è­·ä¿¡æ¯ç­‰)
- ğŸƒ ç™¼é€é‹å‹•æ•¸æ“š (è·é›¢ã€å¡è·¯é‡Œã€é€Ÿåº¦ç­‰)
- â° æ¨¡æ“¬çœŸå¯¦çš„æ™‚é–“é–“éš”å’Œæ•¸æ“šè®ŠåŒ–

**åƒæ•¸é¸é …**ï¼š
```bash
--bikes <æ•¸é‡>      # æ¨¡æ“¬è…³è¸è»Šæ•¸é‡ (é è¨­: 3)
--duration <åˆ†é˜>   # æ¨¡æ“¬æŒçºŒæ™‚é–“ (é è¨­: 5åˆ†é˜)
```

**æ¨¡æ“¬è¡Œç‚º**ï¼š
- éš¨æ©Ÿç§Ÿå€Ÿ/æ­¸é‚„è…³è¸è»Š
- æ¨¡æ“¬ç§»å‹•å’Œé€Ÿåº¦è®ŠåŒ–
- é›»æ± æ¶ˆè€—æ¨¡æ“¬
- çœŸå¯¦çš„ GPS ä½ç½®è®ŠåŒ–

### 3. æ¸¬è©¦åŸ·è¡Œè…³æœ¬ (`run_tests.sh`)

æä¾›ä¾¿æ·çš„æ¸¬è©¦åŸ·è¡Œå’Œç®¡ç†åŠŸèƒ½ï¼š

**ä¸»è¦åŠŸèƒ½**ï¼š
- ğŸ” è‡ªå‹•æª¢æŸ¥ Docker æœå‹™ç‹€æ…‹
- ğŸš€ ä¸€éµå•Ÿå‹•æ‰€æœ‰æœå‹™
- ğŸ§ª é‹è¡Œä¸åŒé¡å‹çš„æ¸¬è©¦
- ğŸ“Š é¡¯ç¤ºå½©è‰²è¼¸å‡ºå’Œç‹€æ…‹ä¿¡æ¯
- ğŸ“‹ æŸ¥çœ‹æœå‹™æ—¥èªŒ

**è…³æœ¬ç‰¹è‰²**ï¼š
- å½©è‰²è¼¸å‡ºï¼Œæ¸…æ™°æ˜“è®€
- è‡ªå‹•éŒ¯èª¤è™•ç†
- æœå‹™ç‹€æ…‹æª¢æŸ¥
- å®Œæ•´çš„æ¸¬è©¦æµç¨‹ç®¡ç†

## ğŸ—ï¸ æ¶æ§‹èªªæ˜

### å–®ä¸€éšŠåˆ—æ¶æ§‹

```
IoTè¨­å‚™ â†’ MQTT â†’ RabbitMQ â†’ Celery Worker â†’ è™•ç†å™¨
                â†“
            iot_default_q (å–®ä¸€éšŠåˆ—)
                â†“
        åŸºæ–¼ message_type è·¯ç”±
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚telemetryâ”‚  fleet  â”‚  sport  â”‚
    â”‚è™•ç†å™¨   â”‚è™•ç†å™¨   â”‚è™•ç†å™¨   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ªå‹¢**ï¼š
- ç°¡åŒ–éšŠåˆ—ç®¡ç†
- æé«˜è³‡æºåˆ©ç”¨ç‡
- çµ±ä¸€çš„éŒ¯èª¤è™•ç†
- éˆæ´»çš„æ¶ˆæ¯è·¯ç”±

### æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰æ¶ˆæ¯éƒ½ä½¿ç”¨çµ±ä¸€çš„æ ¼å¼ï¼š

```json
{
  "message_type": "telemetry|fleet|sport|unknown",
  "bike_id": "bike_001",
  "timestamp": 1753974637,
  "data": {
    // å…·é«”çš„æ¥­å‹™æ•¸æ“š
  },
  "metadata": {
    "source": "mqtt",
    "priority": "normal"
  }
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **æœå‹™æœªå•Ÿå‹•**
   ```bash
   ./koala/mqtt/test/run_tests.sh --start
   ```

2. **MQTT é€£æ¥å¤±æ•—**
   ```bash
   ./koala/mqtt/test/run_tests.sh --logs
   # æª¢æŸ¥ RabbitMQ å’Œ MQTT å®¢æˆ¶ç«¯æ—¥èªŒ
   ```

3. **Celery Worker æœªé‹è¡Œ**
   ```bash
   docker-compose -f backend-local.yml logs koala-iot-default-worker
   ```

4. **æ¸¬è©¦è¶…æ™‚**
   - æª¢æŸ¥ç¶²çµ¡é€£æ¥
   - ç¢ºèªæœå‹™è³‡æºå……è¶³
   - èª¿æ•´æ¸¬è©¦åƒæ•¸

### æ—¥èªŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ
./koala/mqtt/test/run_tests.sh --logs

# æŸ¥çœ‹ç‰¹å®šæœå‹™æ—¥èªŒ
docker-compose -f backend-local.yml logs koala-mqtt-client
docker-compose -f backend-local.yml logs koala-iot-default-worker
docker-compose -f backend-local.yml logs koala-rabbitmq
```

## ğŸ“Š æ¸¬è©¦çµæœè§£è®€

### æˆåŠŸæŒ‡æ¨™

- âœ… æ‰€æœ‰æ¸¬è©¦é€šé
- âœ… æ¶ˆæ¯æ­£ç¢ºè·¯ç”±åˆ°å°æ‡‰è™•ç†å™¨
- âœ… Celery ä»»å‹™æ­£å¸¸åŸ·è¡Œ
- âœ… ç„¡é€£æ¥éŒ¯èª¤æˆ–è¶…æ™‚

### æ€§èƒ½æŒ‡æ¨™

- **æ¶ˆæ¯è™•ç†å»¶é²**: < 100ms
- **ä»»å‹™åŸ·è¡Œæ™‚é–“**: < 50ms
- **ä¸¦ç™¼è™•ç†èƒ½åŠ›**: æ”¯æŒå¤šå€‹ Worker
- **éŒ¯èª¤æ¢å¾©**: è‡ªå‹•é‡é€£å’Œé‡è©¦

## ğŸš€ é€²éšä½¿ç”¨

### è‡ªå®šç¾©æ¸¬è©¦

æ‚¨å¯ä»¥ä¿®æ”¹æ¸¬è©¦æ–‡ä»¶ä¾†æ·»åŠ è‡ªå®šç¾©æ¸¬è©¦ï¼š

1. ç·¨è¼¯ `test_single_queue_architecture.py`
2. æ·»åŠ æ–°çš„æ¸¬è©¦å‡½æ•¸
3. åœ¨ `main()` å‡½æ•¸ä¸­èª¿ç”¨

### æ€§èƒ½æ¸¬è©¦

```bash
# é‹è¡Œé•·æ™‚é–“çš„IoTæ¨¡æ“¬
./koala/mqtt/test/iot_device_simulator.py --bikes 10 --duration 30

# ç›£æ§ç³»çµ±è³‡æº
docker stats
```

### ç”Ÿç”¢ç’°å¢ƒæ¸¬è©¦

åœ¨éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒå‰ï¼Œå»ºè­°ï¼š

1. é‹è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶
2. é€²è¡Œå£“åŠ›æ¸¬è©¦
3. é©—è­‰éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
4. æª¢æŸ¥æ—¥èªŒå’Œç›£æ§

## ğŸ“ æ›´æ–°æ—¥èªŒ

- **v1.0.0**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«åŸºæœ¬æ¸¬è©¦åŠŸèƒ½
- **v1.1.0**: æ·»åŠ  IoT è¨­å‚™æ¨¡æ“¬å™¨
- **v1.2.0**: å¯¦ç¾å–®ä¸€éšŠåˆ—æ¶æ§‹
- **v1.3.0**: æ·»åŠ æ¸¬è©¦åŸ·è¡Œè…³æœ¬
- **v1.4.0**: å®Œå–„æ–‡æª”å’ŒéŒ¯èª¤è™•ç†

## ğŸ¤ è²¢ç»

å¦‚æœæ‚¨ç™¼ç¾å•é¡Œæˆ–æœ‰æ”¹é€²å»ºè­°ï¼Œè«‹ï¼š

1. æª¢æŸ¥ç¾æœ‰æ–‡æª”
2. é‹è¡Œæ¸¬è©¦å¥—ä»¶ç¢ºèªå•é¡Œ
3. æä¾›è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
4. æäº¤æ”¹é€²å»ºè­°

---

**æ³¨æ„**: é‹è¡Œæ¸¬è©¦å‰è«‹ç¢ºä¿ Docker æœå‹™æ­£å¸¸é‹è¡Œï¼Œä¸¦ä¸”æœ‰è¶³å¤ çš„ç³»çµ±è³‡æºã€‚
